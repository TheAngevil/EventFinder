{% extends "layout.html" %}
{% block content %}

  <h2>{{ _('Upcoming Events') }}</h2>

  {# â€”â€” æœå°‹è¡¨å–® â€”â€” #}
  <form id="searchForm" class="search-form">
    <input type="text" name="q"
           placeholder="{{ _('Search by keyword...') }}"
           value="{{ q }}" />
    <button type="submit">{{ _('Search') }}</button>
  </form>

  {# â€”â€” ç©ºçš„æ´»å‹•å®¹å™¨ â€”â€” #}
  <div id="eventGrid" class="event-grid"></div>

  {# â€”â€” è¼‰å…¥ä¸­æŒ‡ç¤ºå™¨ â€”â€” #}
  <div id="loading" style="display:none; text-align:center; margin:1rem;">
    {{ _('Loading more events...') }}
  </div>

  <br>
  {% if current_user.is_authenticated %}
    <a class="btn"
       href="{{ url_for('main.create_event') }}">
      {{ _('Create New Event') }}
    </a>
  {% endif %}

  {# â€”â€” Infinite Scroll Script â€”â€” #}
  <script>
  (function(){
    const grid       = document.getElementById('eventGrid');
    const loader     = document.getElementById('loading');
    const form       = document.getElementById('searchForm');
    let offset       = 0;
    // æ¡Œé¢ 9 ç­†ï¼Œæ‰‹æ©Ÿ 5 ç­†
    const isMobile   = window.matchMedia("only screen and (max-width: 768px)").matches;
    const limit      = isMobile ? 5 : 9;
    let loading      = false;
    let allLoaded    = false;

    // å»ºç«‹å–®å¼µå¡ç‰‡çš„ HTML
    function buildCard(e){
      const tagsHtml = (e.tags||[]).map(t=>
        `<span class="tag">#${t.name}</span>`
      ).join(' ');
      return `
      <div class="event-card">
        <h3>${e.title}</h3>
        <p class="date">ğŸ“… ${e.date.slice(0,10)} ${e.date.slice(11,16)}</p>
        <p>${e.description.slice(0,100)}â€¦</p>
        <div class="tags">${tagsHtml}</div>
        <a class="btn" href="${ location.origin + '/events/' + e.id }">
          {{ _('View Details') }}
        </a>
      </div>`;
    }

    // å–å¾—æ´»å‹•ä¸¦æ¸²æŸ“
    async function fetchEvents(reset=false){
      if(loading||allLoaded) return;
      loading = true;
      loader.style.display = 'block';
      if(reset){
        offset = 0;
        allLoaded = false;
        grid.innerHTML = '';
      }
      const params = new URLSearchParams(new FormData(form));
      params.set('limit', limit);
      params.set('offset', offset);
      const res = await fetch('/api/events?'+params);
      const data = await res.json();
      if(data.length < limit) allLoaded = true;
      data.forEach(e=> grid.insertAdjacentHTML('beforeend', buildCard(e)));
      offset += data.length;
      loading = false;
      loader.style.display = 'none';
    }

    // åˆæ¬¡è¼‰å…¥
    fetchEvents();

    // æœå°‹æ™‚é‡ç½®ä¸¦é‡æ–°è¼‰å…¥
    form.addEventListener('submit', e=>{
      e.preventDefault();
      fetchEvents(true);
    });

    // æ»¾å‹•åˆ°åº•éƒ¨è‡ªå‹•è¼‰æ›´å¤š
    window.addEventListener('scroll', ()=>{
      if(window.innerHeight + window.scrollY >= document.body.offsetHeight - 300){
        fetchEvents();
      }
    });
  })();
  </script>

{% endblock %}
