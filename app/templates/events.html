{% extends "layout.html" %}
{% block content %}

  <h2>{{ _('Upcoming Events') }}</h2>

  {# â€”â€” æœå°‹è¡¨å–® â€”â€” #}
  <form id="searchForm" class="search-form">
    <input type="text" name="q"
           placeholder="{{ _('Search by keyword...') }}"
           value="{{ q or '' }}" />
    <button type="submit">{{ _('Search') }}</button>
  </form>

  {# â€”â€” ç©ºçš„æ´»å‹•å®¹å™¨ â€”â€” #}
  <div id="eventGrid" class="event-grid"></div>

  {# â€”â€” è¼‰å…¥ä¸­æŒ‡ç¤ºå™¨ â€”â€” #}
  <div id="loading" style="display:none; text-align:center; margin:1rem;">
    {{ _('Loading more events...') }}
  </div>

  <br>
  {% if current_user.is_authenticated %}
    <a class="btn" href="{{ url_for('main.create_event') }}">
      {{ _('Create New Event') }}
    </a>
  {% endif %}

  {# â€”â€” Infinite Scroll Script â€”â€” #}
  <script>
  (function(){
    const grid     = document.getElementById('eventGrid');
    const loader   = document.getElementById('loading');
    const form     = document.getElementById('searchForm');
    let offset     = 0;
    const isMobile = window.matchMedia("only screen and (max-width: 768px)").matches;
    const limit    = isMobile ? 5 : 9;
    let loading    = false;
    let done       = false;

    function buildCard(e){
      const tags = (e.tags||[]).map(t=>`<span class="tag">#${t.name}</span>`).join(' ');
      return `
      <div class="event-card">
        <h3>${e.title}</h3>
        <p class="date">ğŸ“… ${e.date.slice(0,10)} ${e.date.slice(11,16)}</p>
        <p>${e.description.slice(0,100)}â€¦</p>
        <div class="tags">${tags}</div>
        <a class="btn" href="/events/${e.id}">{{ _('View Details') }}</a>
      </div>`;
    }

    async function fetchEvents(reset=false){
        console.log('[fetchEvents called]', { reset, offset, limit, loading, done });

        if(reset){
        offset = 0;
        done   = false;
        grid.innerHTML = '';
      }

      if(loading||done) return;
      loading = true;
      loader.style.display = 'block';

      const params = new URLSearchParams(new FormData(form));
      params.set('limit',  limit);
      params.set('offset', offset);

        console.log('[calling api]', '/api/events?' + params);
      const res  = await fetch('/api/events?' + params);
        console.log('[api status]', res.status);
      const data = await res.json();
        console.log('[api data length]', data.length, data);
      if(data.length < limit) done = true;

      data.forEach(e => grid.insertAdjacentHTML('beforeend', buildCard(e)));
      offset += data.length;
      loading = false;
      loader.style.display = 'none';
    }

    // åˆæ¬¡è¼‰å…¥
    fetchEvents();

    // æœå°‹æ™‚é‡ç½®ä¸¦é‡æ‹‰
    form.addEventListener('submit', e => {
      e.preventDefault();
      fetchEvents(true);
    });

    // æ»¾å‹•åˆ°åº•éƒ¨è‡ªå‹•è¼‰æ›´å¤š
    window.addEventListener('scroll', () => {
      if(window.innerHeight + window.scrollY >= document.body.offsetHeight - 300){
        fetchEvents();
      }
    });
  })();
  </script>

{% endblock %}
